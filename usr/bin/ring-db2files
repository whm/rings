#!/usr/bin/perl

##############################################################################
# ring-db2files
##############################################################################
#
# Convert from database picture storage to files based storage.

use DBI;
use Pod::Usage;
use strict;
use Time::Local;
use Rings::Common;

my $opt_conf;
my $opt_debug;
my $opt_help;
my $opt_manual;

# ----------------------------------------------------------------------
# Read a picture from a table and write it to disk

sub export_picture {
    my ($pid, $file, $group, $max_size, $table) = @_;

    create_picture_dirs($group, $max_size);

    my $sel = "SELECT * FROM $table ";
    $sel .= "JOIN picture_types ";
    $sel .= "ON (${table}.picture_type = ? ";
    $sel .= "WHERE pid = ? ";
    dbg($sel) if $CONF->debug;
    my $sth = $DBH->prepare ($sel);
    $sth->execute($pid, $type);

    if (my $row = $sth->fetchrow_hashref) {
        my $type = $row->{type};
        my $thisPictureFile = pid_to_path($pid, $group, $max_size, $type);
        dbg("writing file: $thisPictureFile") if $CONF->debug;
        open PF, ">$thisPictureFile";
        print PF $row->{picture};
        close PF;
    }

    return;
}

# ----------------------------------------------------------------------
# process the files

sub read_and_write {

    # Get sizes to write
    my %psizes = get_picture_sizes();

    # -- get a list of picture ids

    my $sel = "SELECT * FROM pictures_information ";
    my $sth = $DBH->prepare ($sel);
    dbg($sel) if $CONF->debug;
    $sth->execute();

    while (my $row = $sth->fetchrow_hashref) {
        for my $s (keys %psizes) {
            export_picture($row->{pid},
                           $row->{file_name},
                           $row->{group_path},
                           $s,
                           "pictures_$s");
        }
    }
}

# -------------
# Main routine
# -------------

print ">>> ring-db2files\n";

# -- get options
GetOptions(
    'conf=s' => \$opt_conf,
    'debug'  => \$opt_debug,
    'help'   => \$opt_help,
    'manual' => \$opt_manual
);
get_config($opt_conf);

# -- help the poor souls out
pod2usage(-verbose => 0) if $CONF->help;
pod2usage(-verbose => 2) if $CONF->manual;

if ($opt_debug) {
    $CONF->debug($opt_debug);
}

# -- Open up connections to the MySQL data
db_connect();

read_and_write();

db_disconnect;

exit;

__END__

=head1 NAME

ring-db2files

=head1 SYNOPSIS

ring-db2files [properties-file] [--debug] [--help] [--manual]

=head1 DESCRIPTION

This is a conversion script that moves from the rings database schema
where pictures are stored as blobs in the database to the rings where
only meta data is stored in the database and the pictures are stored
as files on disk.

=head1 OPTIONS AND ARGUMENTS

=over 4

=item --help

Displays help text.

=item --manual

Displays more complete help text.

=item --debug

Turns on debugging displays.

=back

=head1 AUTHOR

Bill MacAllister <bill@ca-zephyr.org>

=cut
